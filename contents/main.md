---
marp: true
---

# Kubernetesにシャーディングを全部押し付ける
作成者：tuna2134

---

# 自己紹介

## tuna2134
- 早稲田大学系属校に所属しています。
- neodyなどでbot開発をしています。
- RT, Glow-botなどの運営に携わっています。

---

# shardとは 1
Discordはイベント受信で**websocket**を利用している。それを僕らはゲートウェイと呼んでいる。
ただDiscordサーバ(以降はGuildと呼ぶ)が増えすぎると、サーバに対する負荷が増大してしまう！

---

# shardとは 2
そこでシャード！
シャードはGuildをIDごとに振り分けることができ、イベントを分散して受信ができる。
そうすることでサーバの負荷を軽減することができる。

シャードIDの求め方
```
(GuildのID >> 22) % シャードの数
```

---

# 現状の問題点
人力によるノード分散、人力によるシャードの割り当てをしているせいで、Guildの導入数が増えてしまうとシャードの数を増やさないといけない。(手動k8s)
-> そのため毎回毎回nanoなどのエディターを使ってシャードの割り当てを変更せざるを得ない。

このままやり続けると死ぬ！

---

# そこでk8sにシャーディングを委託しちゃおう！
元々の計画だと、環境変数でシャードIDを渡す方式だったが、Deploymentで動かすため環境変数を各Podずつに渡すことができない。
-> そこでシャードを管理するソフトを作成！(gRPCで取得する仕組み)

---

# 仕組み
1. 起動時にgRPC使って、問い合わせる
2. 返ってきた、シャードIDで割り当てる
3. そのあと定期的にハートビートを送る
  - 一定時間内に来なかった場合、そのシャードIDをべつのに割り当てれるようにする

---

# 完成！
ソフト完成したけど、discord.pyなどを使う場合、内部をいじる必要性があり！

## 注意
discord.pyなどのライブラリだと単一で動かした場合、そういうのをうまくやってくれます。

---
# 今後
これらを今後は実装しようと思います。
- CronJobを使って、シャードの数が適切かどうかチェック！
- 適切ではない場合、k8sのDeploymentのレプリカ数を変更！



---

# ご清聴ありがとうございました。
